# ===================================================================
# ë²”ìš© í”„ë¡œì íŠ¸ ë²„ì „ ìë™ ê´€ë¦¬ ì›Œí¬í”Œë¡œìš° v2.0
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ë‹¤ì–‘í•œ í”„ë¡œì íŠ¸ íƒ€ì…ì—ì„œ main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ 
# patch ë²„ì „ì„ ìë™ìœ¼ë¡œ ì¦ê°€ì‹œí‚¤ê³  ëª¨ë“  ê´€ë ¨ íŒŒì¼ì„ ë™ê¸°í™”í•©ë‹ˆë‹¤.
#
# ì£¼ìš” ê°œì„ ì‚¬í•­:
# - ë²„ì „ ë™ê¸°í™” ìë™í™” (version.yml â†” í”„ë¡œì íŠ¸ íŒŒì¼)
# - ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”
# - ë¡œê¹… ê°œì„ 
# - ìŠ¤í¬ë¦½íŠ¸ ì•ˆì •ì„± í–¥ìƒ
#
# ì§€ì› í”„ë¡œì íŠ¸ íƒ€ì…:
# - spring: build.gradle
# - flutter: pubspec.yaml  
# - react/node: package.json
# - react-native: Info.plist + build.gradle
# - react-native-expo: app.json
# - basic: version.ymlë§Œ ê´€ë¦¬
#
# ===================================================================

name: PROJECT-VERSION-CONTROL

on:
  push:
    branches: ["main"]
    paths-ignore:
      - 'CHANGELOG.md'
      - 'CHANGELOG.json'
      - 'version.yml'  # ë¬´í•œ ë£¨í”„ ë°©ì§€
  workflow_dispatch:

permissions:
  contents: write

jobs:
  version-bump:
    name: ë²„ì „ ìë™ ì¦ê°€
    runs-on: ubuntu-latest

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        run: |
          chmod +x .github/scripts/version_manager.sh
          echo "ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì • ì™„ë£Œ"

      - name: í˜„ì¬ ë²„ì „ í™•ì¸ ë° ë™ê¸°í™”
        id: current_version
        run: |
          echo "ğŸ” í˜„ì¬ ë²„ì „ í™•ì¸ ë° ë™ê¸°í™” ì¤‘..."
          CURRENT_VERSION=$(./.github/scripts/version_manager.sh get | tail -n 1)
          if [ -z "$CURRENT_VERSION" ]; then
            echo "âŒ ë²„ì „ í™•ì¸ ì‹¤íŒ¨"
            exit 1
          fi
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… í˜„ì¬ ë²„ì „: $CURRENT_VERSION"

      - name: ìƒˆ ë²„ì „ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
        id: version
        run: |
          echo "â¬†ï¸ íŒ¨ì¹˜ ë²„ì „ ì¦ê°€ ì¤‘..."
          NEW_VERSION=$(./.github/scripts/version_manager.sh increment | tail -n 1)
          if [ -z "$NEW_VERSION" ]; then
            echo "âŒ ë²„ì „ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"
            exit 1
          fi
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ìƒˆ ë²„ì „: $NEW_VERSION"

      - name: í”„ë¡œì íŠ¸ íƒ€ì… í™•ì¸
        id: project_info
        run: |
          if [ -f "version.yml" ]; then
            PROJECT_TYPE=$(grep "^project_type:" version.yml | sed 's/project_type: *"\([^"]*\)".*/\1/')
            echo "project_type=$PROJECT_TYPE" >> $GITHUB_OUTPUT
            echo "í”„ë¡œì íŠ¸ íƒ€ì…: $PROJECT_TYPE"
          else
            echo "project_type=unknown" >> $GITHUB_OUTPUT
            echo "âš ï¸ version.yml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
        run: |
          echo "ğŸ“ Git ì„¤ì • ë° ë³€ê²½ì‚¬í•­ í™•ì¸ ì¤‘..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # ëª¨ë“  ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
          git add -A
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --staged --quiet; then
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. (ì´ë¯¸ ë™ê¸°í™”ë¨)"
          else
            echo "ğŸ“¤ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì¤‘..."
            REPO_NAME=$(basename "${{ github.repository }}")
            COMMIT_MSG="$REPO_NAME ë²„ì „ ì •ë³´ ê´€ë¦¬: chore: ë²„ì „ ${{ steps.version.outputs.new_version }} [skip ci]"
            
            if git commit -m "$COMMIT_MSG"; then
              git push
              echo "âœ… ë²„ì „ ì—…ë°ì´íŠ¸ ì»¤ë°‹ ì™„ë£Œ"
            else
              echo "âŒ ì»¤ë°‹ ì‹¤íŒ¨"
              exit 1
            fi
          fi

      - name: Git íƒœê·¸ ìƒì„±
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          TAG_NAME="v$NEW_VERSION"
          
          echo "ğŸ·ï¸ Git íƒœê·¸ ìƒì„± ì¤‘: $TAG_NAME"
          
          # ê¸°ì¡´ íƒœê·¸ í™•ì¸
          if git tag -l | grep -q "^$TAG_NAME$"; then
            echo "âš ï¸ íƒœê·¸ $TAG_NAMEì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ê±´ë„ˆë›°ê¸°."
          else
            if git tag "$TAG_NAME" && git push origin "$TAG_NAME"; then
              echo "âœ… Git íƒœê·¸ ìƒì„± ì™„ë£Œ: $TAG_NAME"
            else
              echo "âŒ íƒœê·¸ ìƒì„± ì‹¤íŒ¨: $TAG_NAME"
              exit 1
            fi
          fi

      - name: ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ ìš”ì•½
        if: always()
        run: |
          echo ""
          echo "ğŸ‰ ë²„ì „ ì—…ë°ì´íŠ¸ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š ì—…ë°ì´íŠ¸ ìš”ì•½:"
          echo "  ğŸ“¦ í”„ë¡œì íŠ¸ íƒ€ì…: ${{ steps.project_info.outputs.project_type }}"
          echo "  ğŸ“Œ ì´ì „ ë²„ì „: ${{ steps.current_version.outputs.current_version }}"
          echo "  ğŸ†™ ìƒˆ ë²„ì „: ${{ steps.version.outputs.new_version }}"
          echo "  ğŸ”– Git íƒœê·¸: v${{ steps.version.outputs.new_version }}"
          echo "  ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
          echo "  ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "  ğŸ• ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì—ëŸ¬ í‘œì‹œ
          if [ "${{ job.status }}" != "success" ]; then
            echo "âŒ ì¼ë¶€ ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
          else
            echo "âœ… ëª¨ë“  ë‹¨ê³„ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          fi