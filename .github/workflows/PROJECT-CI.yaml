name: PROJECT-CI

on:
  # main ë¸Œëžœì¹˜ë¡œ PRì´ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

  # main ë¸Œëžœì¹˜ì— pushê°€ ë°œìƒí–ˆì„ ë•Œ
  push:
    branches:
      - main

  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ë¦°íŠ¸ ì²´í¬
        run: |
          if npm run lint --silent 2>/dev/null; then
            echo "âœ… ë¦°íŠ¸ ì²´í¬ ì‹¤í–‰"
            npm run lint
          else
            echo "â„¹ï¸  ë¦°íŠ¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ê±´ë„ˆë›°ê¸°"
          fi

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        id: test-run
        run: |
          echo "ðŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          if CI=true npm test -- --coverage --testResultsProcessor=jest-sonar-reporter --watchAll=false; then
            echo "test_status=success" >> $GITHUB_OUTPUT
            echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤."
          else
            echo "test_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            exit 1
          fi
        env:
          CI: true
        continue-on-error: true

      - name: ë¹Œë“œ ì‹œìž‘ ì‹œê°„ ê¸°ë¡
        id: build-start
        run: echo "time=$(date)" >> $GITHUB_OUTPUT

      - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: |
          echo "ðŸ—ï¸  í”„ë¡œì íŠ¸ ë¹Œë“œ ì¤‘..."
          CI=false npm run build

      - name: ë¹Œë“œ ì •ë³´ ìˆ˜ì§‘
        id: build-info
        run: |
          if [ -d "build" ]; then
            echo "build_status=success" >> $GITHUB_OUTPUT
            BUILD_SIZE=$(du -sh build/ | cut -f1)
            echo "build_size=$BUILD_SIZE" >> $GITHUB_OUTPUT

            # ì£¼ìš” íŒŒì¼ë“¤ ëª©ë¡ ìƒì„±
            BUILD_FILES=$(find build/static -name "*.js" -o -name "*.css" | head -10 | sed 's|build/||' | tr '\n' ', ' | sed 's/,$//')
            echo "build_files=$BUILD_FILES" >> $GITHUB_OUTPUT

            # ë¹Œë“œ ì‹œê°„ ê³„ì‚°
            BUILD_TIME=$(date -d "${{ steps.build-start.outputs.time }}" +%s 2>/dev/null || echo "0")
            CURRENT_TIME=$(date +%s)
            DURATION=$((CURRENT_TIME - BUILD_TIME))
            echo "build_duration=${DURATION}ì´ˆ" >> $GITHUB_OUTPUT

            echo "âœ… ë¹Œë“œ ì„±ê³µ! build ë””ë ‰í† ë¦¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "ðŸ“¦ ë¹Œë“œ í¬ê¸°: $BUILD_SIZE"
          else
            echo "build_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ ë¹Œë“œ ì‹¤íŒ¨: build ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
        continue-on-error: true

      - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-coverage
          path: coverage/
          retention-days: 7

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-artifacts
          path: build/
          retention-days: 30

      - name: ì‹¤íŒ¨ ì •ë³´ ìˆ˜ì§‘
        id: failure-info
        if: failure()
        run: |
          echo "collecting_failure_info=true" >> $GITHUB_OUTPUT

          # GitHub Actions ë¡œê·¸ URL ìƒì„±
          ACTION_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "action_url=$ACTION_URL" >> $GITHUB_OUTPUT

          # ìµœê·¼ ì˜¤ë¥˜ ë¡œê·¸ ìˆ˜ì§‘ (ì¶”ì •)
          ERROR_CONTEXT="ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          if [ "${{ steps.test-run.outputs.test_status }}" = "failed" ]; then
            ERROR_CONTEXT="í…ŒìŠ¤íŠ¸ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
          elif [ "${{ steps.build-info.outputs.build_status }}" = "failed" ]; then
            ERROR_CONTEXT="ë¹Œë“œ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. build ë””ë ‰í† ë¦¬ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi
          echo "error_context=$ERROR_CONTEXT" >> $GITHUB_OUTPUT

      - name: PRì— ì„±ê³µ ëŒ“ê¸€ ë‚¨ê¸°ê¸°
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const buildSize = '${{ steps.build-info.outputs.build_size }}';
            const buildFiles = '${{ steps.build-info.outputs.build_files }}';
            const buildDuration = '${{ steps.build-info.outputs.build_duration }}';

            const comment = `## ðŸš€ CI ë¹Œë“œ ì„±ê³µ!

            ### ðŸ“¦ ë¹Œë“œ ì •ë³´
            - **ë¹Œë“œ í¬ê¸°**: ${buildSize}
            - **ë¹Œë“œ ì‹œê°„**: ${buildDuration}
            - **ì»¤ë°‹**: \`${{ github.sha }}\`
            - **ë¸Œëžœì¹˜**: \`${{ github.head_ref || github.ref_name }}\`

            ### ðŸ“ ìƒì„±ëœ íŒŒì¼
            \`\`\`
            ${buildFiles || 'ì£¼ìš” JS/CSS íŒŒì¼ë“¤ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤'}
            \`\`\`

            ### âœ… ëª¨ë“  ê²€ì‚¬ í†µê³¼
            - ë¦°íŠ¸ ì²´í¬ âœ…
            - í…ŒìŠ¤íŠ¸ ì‹¤í–‰ âœ…
            - ë¹Œë“œ ìƒì„± âœ…

            *ìžë™ ìƒì„±ëœ ëŒ“ê¸€ìž…ë‹ˆë‹¤.*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: PRì— ì‹¤íŒ¨ ëŒ“ê¸€ ë‚¨ê¸°ê¸°
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const actionUrl = '${{ steps.failure-info.outputs.action_url }}';
            const errorContext = '${{ steps.failure-info.outputs.error_context }}';

            const comment = `## âŒ CI ë¹Œë“œ ì‹¤íŒ¨

            ### ðŸš¨ ì˜¤ë¥˜ ì •ë³´
            ${errorContext}

            ### ðŸ“‹ ì‹¤í–‰ ì •ë³´
            - **ì»¤ë°‹**: \`${{ github.sha }}\`
            - **ë¸Œëžœì¹˜**: \`${{ github.head_ref || github.ref_name }}\`
            - **ì‹¤í–‰ ì‹œê°„**: ${{ steps.build-start.outputs.time }}

            ### ðŸ” ë¬¸ì œ í•´ê²°
            ìžì„¸í•œ ì˜¤ë¥˜ ë¡œê·¸ëŠ” [GitHub Actions ì‹¤í–‰ ê²°ê³¼](${actionUrl})ì—ì„œ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

            **ì¼ë°˜ì ì¸ í•´ê²° ë°©ë²•:**
            1. ë¡œì»¬ì—ì„œ \`npm install\` ë° \`npm run build\` ì‹¤í–‰ í™•ì¸
            2. ë¦°íŠ¸ ì˜¤ë¥˜: \`npm run lint\` (ìžˆëŠ” ê²½ìš°) ì‹¤í–‰í•˜ì—¬ ì½”ë“œ ìŠ¤íƒ€ì¼ í™•ì¸
            3. í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: \`npm test\` ì‹¤í–‰í•˜ì—¬ ë¡œì»¬ì—ì„œ í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸

            *ìžë™ ìƒì„±ëœ ëŒ“ê¸€ìž…ë‹ˆë‹¤.*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: CI ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "## ðŸš€ CI ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œëžœì¹˜**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì´ë²¤íŠ¸**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "- **ìƒíƒœ**: âœ… ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
            echo "- **ë¹Œë“œ í¬ê¸°**: ${{ steps.build-info.outputs.build_size }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **ìƒíƒœ**: âŒ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
            echo "- **Action URL**: ${{ steps.failure-info.outputs.action_url }}" >> $GITHUB_STEP_SUMMARY
          fi